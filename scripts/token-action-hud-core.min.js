const t={ID:"token-action-hud-core",NAME:"Token Action HUD"},e="|",o={compendiumEntry:"tokenActionHud.compendiumEntry",compendiumMacro:"tokenActionHud.compendiumMacro",compendiumPlaylist:"tokenActionHud.compendiumPlaylist",macro:"tokenActionHud.macro"},i=["compendiumEntry","compendiumMacro","compendiumPlaylist","macro"],s=["JournalEntry","Macro","RollTable"],n={compact:{file:"tah-compact"},dorakoUI:{file:"tah-dorako"},foundryVTT:{file:"tah-foundry-vtt"},highContrast:{file:"tah-high-contrast"},pathfinder:{file:"tah-pathfinder"},custom:{file:"tah-custom"}},a={backgroundColor:{cssProperty:"--tah-background-color",type:String,default:"#00000000"},buttonHeight:{cssProperty:"--tah-button-height-editable",type:Number,default:32},buttonBackgroundColor:{cssProperty:"--tah-button-background-color-editable",type:String,default:"#000000b3"},buttonBorderPrimaryColor:{cssProperty:"--tah-button-border-primary-color-editable",type:String,default:"#0C0C0CFF"},buttonBorderSecondaryColor:{cssProperty:"--tah-button-border-secondary-color-editable",type:String,default:"#060606FF"},buttonTextColor:{cssProperty:"--tah-button-text-color-editable",type:String,default:"#DDDDDDFF"},buttonHoverBorderPrimaryColor:{cssProperty:"--tah-button-hover-border-primary-color-editable",type:String,default:"#FF6400FF"},buttonHoverBorderSecondaryColor:{cssProperty:"--tah-button-hover-border-secondary-color-editable",type:String,default:"#FF0000FF"},buttonHoverBackgroundColor:{cssProperty:"--tah-button-hover-background-color-editable",type:String,default:"#000000B3"},buttonHoverTextColor:{cssProperty:"--tah-button-hover-text-color-editable",type:String,default:"#FFFFFFFF"},buttonToggleActiveBackgroundColor:{cssProperty:"--tah-button-toggle-active-background-color-editable",type:String,default:"#3C0078BF"},buttonToggleActiveBorderPrimaryColor:{cssProperty:"--tah-button-toggle-active-border-primary-color-editable",type:String,default:"#9B8DFFFF"},buttonToggleActiveBorderSecondaryColor:{cssProperty:"--tah-button-toggle-active-border-secondary-color-editable",type:String,default:"#9B8DFFFF"},buttonToggleActiveTextColor:{cssProperty:"--tah-button-toggle-active-text-color-editable",type:String,default:"#FFFFFFFF"},buttonToggleHoverBackgroundColor:{cssProperty:"--tah-button-toggle-hover-background-color-editable",type:String,default:"#3C0078BF"},buttonToggleHoverBorderPrimaryColor:{cssProperty:"--tah-button-toggle-hover-border-primary-color-editable",type:String,default:"#9B8DFFFF"},buttonToggleHoverBorderSecondaryColor:{cssProperty:"--tah-button-toggle-hover-secondary-color-editable",type:String,default:"#9B8DFFFF"},buttonToggleHoverTextColor:{cssProperty:"--tah-button-toggle-hover-text-color-editable",type:String,default:"#FFFFFFFF"},textPrimaryColor:{cssProperty:"--tah-text-primary-color-editable",type:String,default:"#DDDDDDFF"},textSecondaryColor:{cssProperty:"--tah-text-secondary-color-editable",type:String,default:"#DDDDDD80"},textTertiaryColor:{cssProperty:"--tah-text-tertiary-color-editable",type:String,default:"#FF6400FF"},textHoverPrimaryColor:{cssProperty:"--tah-text-hover-primary-color-editable",type:String,default:"#DDDDDDFF"},textHoverSecondaryColor:{cssProperty:"--tah-text-hover-secondary-color-editable",type:String,default:"#DDDDDD80"},textHoverTertiaryColor:{cssProperty:"--tah-text-tertiary-color-editable",type:String,default:"#FF6400FF"}},r={COMPENDIUM:"compendium",CUSTOM:"custom",SYSTEM:"system",SYSTEM_DERIVED:"system-derived"},l={ICON:"fas fa-sd-card",TOOLTIP:"Item Macro"},c={compact:{class:"tah-style-foundry-vtt",primaryColor:"#dddddd",secondaryColor:"#dddddd80",tertiaryColor:"#ff6400"},custom:{class:"tah-style-custom"},dorakoUI:{class:"tah-style-dorako-ui"},foundryVTT:{class:"tah-style-foundry-vtt",primaryColor:"#dddddd",secondaryColor:"#dddddd80",tertiaryColor:"#ff6400"},highContrast:{class:"tah-style-high-contrast",primaryColor:"#ffff00",secondaryColor:"#ffff00",tertiaryColor:"#0C7BDC"},pathfinder:{class:"tah-style-pathfinder"}};class Logger{static info(t,e=!1){e?ui.notifications.info(`Token Action HUD | ${t}`):console.log(`Token Action HUD Info | ${t}`)}static error(t,e=!1){e?ui.notifications.error(`Token Action HUD | ${t}`):console.error(`Token Action HUD Error | ${t}`)}static debug(t,e){if(game.tokenActionHud?game.tokenActionHud.isDebug:Utils.getSetting("debug")){if(!e)return void console.log(`Token Action HUD Debug | ${t}`);const o=Utils.deepClone(e);console.log(`Token Action HUD Debug | ${t}`,o)}}}class Timer{contructor(t){this.milliseconds=t,this.timer=null}async start(){return this.timer&&this.abort(),new Promise((t=>{this.timer=setTimeout(t,this.milliseconds)}))}async abort(){clearTimeout(this.timer),this.timer=null}}class Utils{static checkAllow(t){return t>=this.getSetting("allow")}static deepClone(t,e){return deepClone(t,e)}static getActor(t,e){let o=null;return e&&(o=canvas.tokens.placeables.find((t=>t.id===e))),o?o.actor:game.actors.get(t)}static getImage(t,e=[]){e.push("icons/svg/mystery-man.svg");let o="";return game.tokenActionHud.isDisplayIcons&&(o="string"==typeof t?t:t?.img??t?.icon??""),e.includes(o)?"":o}static getItem(t,e){return t.items.get(e)}static getToken(t){return canvas.tokens.placeables.find((e=>e.id===t))}static getControlledTokens(){return game.canvas.tokens.controlled}static getFirstControlledToken(){return game.canvas.tokens.controlled[0]}static getSetting(e,o=null){let i=o??null;try{i=game.settings.get(t.ID,e)}catch{Logger.debug(`Setting '${e}' not found`)}return i}static async setSetting(e,o){game.settings.settings.get(`${t.ID}.${e}`)?(await game.settings.set(t.ID,e,o),Logger.debug(`Setting '${e}' set to '${o}'`)):Logger.debug(`Setting '${e}' not found`)}static getActorFlag(e){return game.tokenActionHud.actor.getFlag(t.ID,e)}static async setActorFlag(e,o){await game.tokenActionHud.actor.setFlag(t.ID,e,o)}static async unsetActorFlag(e){await game.tokenActionHud.actor.unsetFlag(t.ID,e)}static getUserFlag(e){return game.user.getFlag(t.ID,e)}static async setUserFlag(e,o){await game.user.setFlag(t.ID,e,o)}static async unsetUserFlag(e){await game.user.unsetFlag(t.ID,e)}static i18n(t){return game.i18n.localize(t)}static isModuleActive(t){const e=game.modules.get(t);return e&&e.active}static getModuleTitle(t){return game.modules.get(t)?.title??""}static humanizeBinding(e){const o=game.keybindings.get(t.ID,e);if(!o)return"";return o[0].modifiers.reduce(((t,e)=>(KeyboardManager.MODIFIER_CODES[e]?.includes(o[0].key)||t.unshift(KeyboardManager.getKeycodeDisplayString(e)),t)),[KeyboardManager.getKeycodeDisplayString(o[0].key)]).join(" + ")}static median(t){const e=Math.floor(t.length/2),o=[...t].sort(((t,e)=>t-e));return t.length%2!=0?o[e]:(o[e-1]+o[e])/2}static sortItems(t){return new Map([...t.entries()].sort(((t,e)=>t[1].sort.localeCompare(e[1].sort))))}static sortItemsByName(t){return new Map([...t.entries()].sort(((t,e)=>t[1].name.localeCompare(e[1].name))))}static switchCSS(e){for(const[o,i]of Object.entries(n)){const s=[`modules/${t.ID}/`,`styles/${i.file}`];Object.values(document.styleSheets).find((t=>t.href?.includes(s[0])&&t.href?.includes(s[1]))).disabled=o!==e}if("custom"===e)for(const[t,e]of Object.entries(a)){const o=Utils.getSetting(t);o&&document.querySelector(":root").style.setProperty(e.cssProperty,o)}}static registerHandlebars(){Handlebars.registerHelper("cap",(function(t){return!t||t.length<1?"":t[0].toUpperCase()+t.slice(1)}));const reduceOp=function(t,e){(t=Array.from(t)).pop();const o=t.shift();return t.reduce(e,o)};Handlebars.registerHelper({eq:function(){return reduceOp(arguments,((t,e)=>t===e))},ne:function(){return reduceOp(arguments,((t,e)=>t!==e))},lt:function(){return reduceOp(arguments,((t,e)=>t<e))},gt:function(){return reduceOp(arguments,((t,e)=>t>e))},lte:function(){return reduceOp(arguments,((t,e)=>t<=e))},gte:function(){return reduceOp(arguments,((t,e)=>t>=e))},and:function(){return reduceOp(arguments,((t,e)=>t&&e))},or:function(){return reduceOp(arguments,((t,e)=>t||e))},true:function(){return reduceOp(arguments,(t=>t))},false:function(){return reduceOp(arguments,(t=>!t))}}),Handlebars.registerHelper("activeText",(function(t){return Utils.getSetting("activeCssAsText")?t.fn(this):t.inverse(this)}))}static getModuleVersionParts(t){if(!t)return void Logger.debug("Module version not retrieved",{trigger:"getModuleVersionParts"});const e=t.split(".");return{major:e[0],minor:e[1],patch:e[2]}}static async checkModuleCompatibility(e){const o=this.getModuleVersionParts(e),i=this.getModuleVersionParts(game.modules.get(t.ID).version);return!(i.major!==o.major||i.minor!==o.minor||o.patch&&i.patch!==o.patch)||(ui.notifications.error(`The installed Token Action HUD system module requires Token Action HUD Core module version ${e}. Install the required version to continue using Token Action HUD.`),!1)}static getSubcategories(t,e={}){let o=0;if(!t)return;const i=e?.id,s=e?.type;t=Array.isArray(t)?t:Object.values(t);const n={};for(const a of t){if(!(i&&a.id!==i||s&&a.type!==s)){o++;const t=a.nestId.split("_").length;n[a.nestId]={...a,order:o,level:t}}if(a.subcategories?.length>0){const t=this.getSubcategories(a.subcategories,e);t&&Object.assign(n,t)}}return Object.keys(n).length>0?n:null}static getNestedGroups(t,e={}){let o=0;if(!t)return;const i=e?.id,s=e?.type;t=Array.isArray(t)?t:Object.values(t);const n={};for(const a of t){if(!(i&&a.id!==i||s&&a.type!==s)){o++;const t=a.nestId.split("_").length;n[a.nestId]={...a,order:o,level:t}}if(a.groups?.length>0){const t=this.getNestedGroups(a.groups,e);t&&Object.assign(n,t)}}return Object.keys(n).length>0?n:null}static async getGroupByNestId(t,e={}){const o="string"==typeof e?e:e?.nestId,i=e?.type;if(!o)return;const s=o.split("_");return await async function findGroup(t,e){t=Array.isArray(t)?t:Object.values(t);for(const o of t)if(o.id===e[0]){if(1===e.length)return o.type&&i&&o.type!==i?void 0:o;e.shift();for(const t of Object.values(o.groups)){if(0===t.length)continue;const o=await findGroup(t,e);if(o)return o}}}(t,s)}static async deleteGroupByNestId(t,e={}){const o="string"==typeof e?e:e?.nestId;if(!o)return;const i=o.split("_");return await async function findGroup(t,e){t=Array.isArray(t)?t:Object.values(t);for(const[o,i]of t.entries())if(i.id===e[0]){if(1===e.length)return void t.splice(o,1);if(0===i.groups.length)return;e.shift();const s=await findGroup(i.groups,e);if(s)return}}(t,i)}static async deleteGroupsById(t,e={}){const o="string"==typeof e?e:e?.id;if(o)for(let i=t.length-1;i>=0;i--)t[i].id===o?t.splice(i,1):t[i].groups?.length>0&&this.deleteGroupsById(t[i].groups,e)}}class DataHandler{static async createDirectories(){const e="data",o=t.ID;await FilePicker.browse(e,o).catch((async t=>{await FilePicker.createDirectory(e,o,{})||Logger.debug("Failed to create directory: "+o)}));const i=`${t.ID}/${game.world.id}`;await FilePicker.browse(e,i).catch((async t=>{await FilePicker.createDirectory(e,i,{})||Logger.debug("Failed to create directory: "+i)}));const s=`${i}/actor`;await FilePicker.browse(e,s).catch((async t=>{await FilePicker.createDirectory(e,s,{})||Logger.debug("Failed to create directory: "+s)}));const n=`${i}/user`;await FilePicker.browse(e,n).catch((async t=>{await FilePicker.createDirectory(e,n,{})||Logger.debug("Failed to create directory: "+n)}))}static async saveData(e,o,i){const s=`${t.ID}/${game.world.id}/${e}`,n=encodeURI(`${o}.json`),a=new File([JSON.stringify(i,null,"")],n,{type:"application/json"}),r=await FilePicker.upload("data",s,a,{},{notify:!1});r.path||Logger.debug(`Failed to save data to: ${n}\nReason: ${r}`)}static async getData(e,o){const i=`${t.ID}/${game.world.id}/${e}`,s=encodeURI(`${o}.json`);try{const t=(await FilePicker.browse("data",i)).files.find((t=>t.endsWith(s)));return t?fetch(t).then((t=>t.ok?t.json():null)).catch((t=>{console.error(t)})):null}catch{return null}}}class GenericActionHandler{actionHandler;constructor(t){this.actionHandler=t,this.actor=t.actor,this.token=t.token}buildGenericActions(){this._buildConditions(),this._buildUtilities()}_buildConditions(){}_buildUtilities(){if(this.actor)return this._buildSingleTokenUtilities();this._buildMultipleTokenUtilities()}_buildSingleTokenUtilities(){if(!this.token)return;const t=[],e="utility",o="toggleCombat",i=canvas.tokens.placeables.find((t=>t.id===this.token.id)).inCombat?Utils.i18n("tokenActionHud.removeFromCombat"):Utils.i18n("tokenActionHud.addToCombat"),s=[e,o].join("|"),n={id:o,name:i,encodedValue:s,selected:!0};if(t.push(n),game.user.isGM){const o="toggleVisibility",i=canvas.tokens.placeables.find((t=>t.id===this.token.id)).document.hidden?Utils.i18n("tokenActionHud.makeVisible"):Utils.i18n("tokenActionHud.makeInvisible"),s=[e,o].join("|"),n={id:o,name:i,encodedValue:s,selected:!0};t.push(n)}const a={id:"token",type:r.SYSTEM};this.actionHandler.addActions(t,a)}_buildMultipleTokenUtilities(){const t=Utils.getControlledTokens(),e=[],o="utility",i="toggleCombat",s=t.every((t=>t.inCombat))?Utils.i18n("tokenActionHud.removeFromCombat"):Utils.i18n("tokenActionHud.addToCombat"),n=[o,i].join("|"),a={id:i,name:s,encodedValue:n};if(e.push(a),game.user.isGM){const i="toggleVisibility",s=t.every((t=>t.document.hidden))?Utils.i18n("tokenActionHud.makeVisible"):Utils.i18n("tokenActionHud.makeInvisible"),n=[o,i].join("|"),a={id:i,name:s,encodedValue:n};e.push(a)}const l={id:"token",type:r.SYSTEM};this.actionHandler.addActions(e,l)}}class CompendiumActionHandler{actionHandler;constructor(t){this.actionHandler=t}async buildCompendiumActions(){const t=game.packs.filter((t=>s.includes(t.documentName)&&(!t.private||game.user.isGM))).map((t=>t.metadata.id));for(const e of t){const t=await this._getCompendiumActions(e),o={id:e.replace(".","-"),type:"core"};this.actionHandler.addActions(t,o)}}async _getCompendiumActions(t){const e=await this._getCompendiumEntries(t),i=this._getCompendiumActionType(t);return e.map((e=>{const s=e._id,n=e.name,a=`${`${Utils.i18n(o[i])}: `??""}${n}`;return{id:s,name:n,encodedValue:[i,t,e._id].join("|"),img:Utils.getImage(e),listName:a}}))}async _getCompendiumEntries(t){const e=game.packs.get(t);if(!e)return[];const o=e.index.size>0?e.index:await e.getIndex();if("Playlist"===e.documentName){return await this._getPlaylistEntries(e)}return o}async _getPlaylistEntries(t){return(await t.getContent()).reduce(((t,e)=>(e.sounds.forEach((o=>{t.push({_id:`${e._id}>${o._id}`,name:o.name})})),t)),[])}_getCompendiumActionType(t){const e=game?.packs?.get(t);if(!e)return"";switch(e.documentName){case"Macro":return"compendiumMacro";case"Playlist":return"compendiumPlaylist";default:return"compendiumEntry"}}}class MacroActionHandler{actionHandler;constructor(t){this.actionHandler=t}async buildMacroActions(){const t=await this._getActions();this.actionHandler.addActions(t,{id:"macros",type:"core"})}async _getActions(){const t="macro";return game.macros.filter((t=>{const e=t.ownership;return e[game.userId]?e[game.userId]>0:e.default>0})).map((e=>{const i=e.id,s=e.name;return{id:i,name:s,listName:`${`${Utils.i18n(o[t])}: `??""}${s}`,encodedValue:[t,e.id].join("|"),img:Utils.getImage(e)}}))}}class ActionHandler{characterName=null;actor=null;token=null;furtherActionHandlers=[];delimiter="|";constructor(){this.genericActionHandler=new GenericActionHandler(this),this.compendiumActionHandler=new CompendiumActionHandler(this),this.macroActionHandler=new MacroActionHandler(this),this.hud=[],this.defaultGroups={},this.defaultLayout={},this.groups={},this.actorGroups={},this.userGroups={},this.actions=[],this.availableActions=[],this.displayIcons=Utils.getSetting("displayIcons"),this.isCustomizationEnabled=Utils.getSetting("enableCustomization")}resetActionHandler(){this.genericActionHandler=new GenericActionHandler(this),this.compendiumActionHandler=new CompendiumActionHandler(this),this.macroActionHandler=new MacroActionHandler(this),this.hud=[],this.defaultGroups={},this.defaultLayout={},this.groups={},this.actorGroups={},this.userGroups={},this.actions=[],this.availableActions=[],this.displayIcons=Utils.getSetting("displayIcons")}async registerDefaultCategories(){}async buildHud(t){return Logger.debug("Building HUD...",{actor:this.actor,token:this.token}),this.resetActionHandler(),await this._getDefaultGroups(),await this._getDefaultLayout(),await this._getSavedUserGroups(),this.actor&&await this._getSavedActorGroups(),this.hud=await this._prepareHud(),await Promise.all([this._buildSystemActions(),this._buildGenericActions(),this._buildCompendiumActions(),this._buildMacroActions()]),await this.buildFurtherActions(),await this._updateNonPresetActions(),await this._setHasActions(),await this._sortAvailableActions(),await this._setCharacterLimit(),await this.saveGroups(t),Logger.debug("HUD built",{hud:this.hud,actor:this.actor,token:this.token}),this.hud}async _prepareHud(){Logger.debug("Preparing HUD...",{actor:this.actor,token:this.token});const t=Utils.getSetting("displayCharacterName")?this.characterName??"Multiple":"",e=this.actor?.id??"multi",o={title:t,tokenId:this.token?.id??"multi",actorId:e,groups:[]};if(Object.keys(this.userGroups).length){const t=this._getUserGroups();for(const e of t)if(1===e.level){const t=this._createGroup(e);o.groups.push(t),this.groups[t.nestId]=t}else{const t=e.nestId.split("_",e.level-1).join("_"),i=await Utils.getGroupByNestId(o.groups,{nestId:t});if(i){const t=this._createGroup(e);"tab"===t.settings.style?i.groups.tabs.push(t):i.groups.lists.push(t),this.groups[t.nestId]=t}}}if(Object.keys(this.actorGroups).length){const t=this._getActorGroups();for(const e of t){const t=e.nestId.split("_",e.level-1).join("_"),i=await Utils.getGroupByNestId(o.groups,{nestId:e.nestId});if(i){if(e.actions?.length){i.actions=e.actions,this.actions.push(...i.actions);for(const t of i.actions)t.selected=!1}}else{const i=await Utils.getGroupByNestId(o.groups,{nestId:t});if(i&&"system-derived"===e.type){const t=this._createGroup(e);if(e.actions?.length){t.actions=e.actions,this.actions.push(...t.actions);for(const e of t.actions)e.selected=!1}"tab"===t.settings.style?i.groups.tabs.push(t):i.groups.lists.push(t),this.groups[t.nestId]=t}}}}return Logger.debug("HUD prepared",{hud:o,actor:this.actor,token:this.token}),o}async buildSystemActions(t){}async _buildSystemActions(){Logger.debug("Building system actions...",{actor:this.actor,token:this.token});const t=Object.values(this.groups).map((t=>t.id));await this.buildSystemActions(t),Logger.debug("System actions built",{hud:this.hud,actor:this.actor,token:this.token})}async _buildCompendiumActions(){Logger.debug("Building compendium actions..."),await this.compendiumActionHandler.buildCompendiumActions(),Logger.debug("Compendium actions built",{hud:this.hud})}_buildGenericActions(){Logger.debug("Building generic actions...",{actor:this.actor,token:this.token}),this.genericActionHandler.buildGenericActions(),Logger.debug("Generic actions built",{hud:this.hud,actor:this.actor,token:this.token})}async _buildMacroActions(){Logger.debug("Building macro actions..."),await this.macroActionHandler.buildMacroActions(),Logger.debug("Macro actions built",{hud:this.hud})}async buildFurtherActions(){this.furtherActionHandlers.forEach((t=>t.extendActionList()))}async _updateNonPresetActions(){const t=this.actions.filter((t=>!t?.isPreset));for(const e of t){const t=this.availableActions.find((t=>t.id===e.id));if(t){const o=t.systemSelected??e.systemSelected,i=e.userSelected??t.userSelected;Object.assign(e,this._createAction({...t,systemSelected:o,userSelected:i}))}}}async _setHasActions(){for(const t of Object.values(this.groups))t.actions.some((t=>t.selected))?t.hasActions=!0:t.hasActions=!1}async _getDefaultGroups(){const t=game.tokenActionHud.defaults?.groups?.length?game.tokenActionHud.defaults?.groups:game.tokenActionHud.defaults?.subcategories;if(!t)return{};for(const e of t)this.defaultGroups[e.id]=e}async _getDefaultLayout(){const t=game.tokenActionHud.defaults?.layout?.length?game.tokenActionHud.defaults?.layout:game.tokenActionHud.defaults?.categories;if(!t)return{};this.defaultLayout=await Utils.getNestedGroups(t)}async _getSavedActorGroups(){if(!this.actor||!this.isCustomizationEnabled)return new Map;Logger.debug("Retrieving groups from actor...",{actor:this.actor});const t=await game.tokenActionHud.socket.executeAsGM("getData","actor",this.actor.id)??null;if(!t)return null;for(const e of Object.entries(t))e[1].nestId=e[0];this.actorGroups=t,Logger.debug("Groups from actor retrieved",{actorGroups:this.actorGroups,actor:this.actor})}async _getSavedUserGroups(){const t=game.user,getUserGroups=t=>{const e=Object.keys(t).length?t:this.defaultLayout;for(const t of Object.entries(e))t[1].nestId=t[0];return e};if(this.isCustomizationEnabled){Logger.debug("Retrieving groups from user...",{user:t});const e=await game.tokenActionHud.socket.executeAsGM("getData","user",t.id)??{};this.userGroups=getUserGroups(e),Logger.debug("Groups retrieved from user",{userGroups:this.userGroups,user:t})}else this.userGroups=getUserGroups(this.defaultLayout)}_getGroup(t={}){return t?.nestId?this.groups[t.nestId]:Object.values(this.groups).find((e=>!(t.id&&e.id!==t.id||t.type&&e.type!==t.type||t.level&&e.level!==t.level)))}_getGroups(t={}){return Object.values(this.groups).filter((e=>(!t.id||e.id===t.id)&&(!t.nestId||e.nestId.startsWith(t.nestId))&&(!t.type||e.type===t.type)&&(!t.level||e.level===t.level)&&(!t.isSelected||e.isSelected===t.isSelected)))}_getActorGroups(t={}){return Object.values(this.actorGroups).filter((e=>(!t.id||e.id===t.id)&&(!t.nestId||e.nestId.startsWith(t.nestId))&&(!t.type||e.type===t.type)&&(!t.level||e.level===t.level))).sort(((t,e)=>t.level===e.level?t.order-e.order:t.level-e.level))}_getUserGroups(t={}){return Object.values(this.userGroups).filter((e=>(!t.id||e.id===t.id)&&(!t.nestId||e.nestId.startsWith(t.nestId))&&(!t.type||e.type===t.type)&&(!t.level||e.level===t.level))).sort(((t,e)=>t.level===e.level?t.order-e.order:t.level-e.level))}async getGroupSettings(t){return this._getGroup(t)?.settings??null}async saveGroupSettings(t){const e=this._getGroup(t);e.settings={...e.settings,...t.settings},this.saveGroups({saveActor:!0,saveUser:!0})}_createGroup(t){const e=Utils.deepClone(t);e?.settings||(e.settings={}),void 0===e?.settings?.showTitle&&(e.settings.showTitle=!0),e.subtitleClass=e?.settings?.showTitle?"":"tah-hidden";const o=t.nestId.split("_"),i=o.length??1;return 1===i?(void 0===e?.settings?.style&&(e.settings.style="tab"),{actions:[],cssClass:"",groups:{lists:[],tabs:[]},id:e?.id,isSelected:e?.isSelected??!0,level:e?.level??o.length??1,name:e?.name,nestId:e?.nestId??e?.id,order:e.order,settings:e?.settings??{style:"tab"},type:"custom"}):(void 0===e?.settings?.style&&(e.settings.style="list"),{id:e?.id,nestId:e?.nestId,name:e?.name,listName:e?.listName,isSelected:e?.isSelected??!0,level:e.level??i,order:e.order,settings:e?.settings??{showTitle:!0,style:"list"},type:e?.type??r.CUSTOM,subtitleClass:e?.subtitleClass??"",info1:e?.info1??"",info2:e?.info2??"",info3:e?.info3??"",groups:{lists:[],tabs:[]},actions:[]})}async updateGroups(t,e){Array.isArray(t)||(t=[t]);const o={level:(e?.level??0)+1};e?.nestId&&(o.nestId=e.nestId);const i=this._getGroups(o);for(const e of i)"system-derived"===e.type?e.isSelected=!1:t.find((t=>t.id===e.id))||delete this.groups[e.nestId];let s=0;for(const o of t){o.nestId=e?.nestId?`${e.nestId}_${o.id}`:o.id,o.isSelected=o.isSelected??!0,o.order=s;const t=this._getGroup(o);if(t)Object.assign(t,o);else{const t=this._createGroup(o);this.groups[o.nestId]=t}s++}if(e?.settings){const t=this._getGroup(e);t&&(t.settings=e.settings)}}async saveGroups(t={saveActor:!1,saveUser:!1}){this.isCustomizationEnabled&&(Logger.debug("Saving groups..."),t?.saveActor&&await this._saveActorGroups(),t?.saveUser&&await this._saveUserGroups(),Logger.debug("Groups saved",{groups:this.groups}))}async _saveActorGroups(){if(!Object.keys(this.groups).length)return;Logger.debug("Saving actor groups...");const t={};for(const e of Object.values(this.groups))t[e.nestId]=this._getReducedGroupData(e,!0);await game.tokenActionHud.socket.executeAsGM("saveData","actor",this.actor.id,t),Logger.debug("Actor groups saved",{actorGroups:t})}async _saveUserGroups(){if(!Object.keys(this.groups).length)return;Logger.debug("Saving user groups...");const t={};for(const e of Object.values(this.groups))"system-derived"!==e.type&&(t[e.nestId]=this._getReducedGroupData(e,!1));await game.tokenActionHud.socket.executeAsGM("saveData","user",game.userId,t),Logger.debug("User groups saved",{userGroups:t})}_getReducedGroupData(t,e=!1){const o={id:t.id,name:t.name,listName:t.listName,isSelected:t.isSelected,level:t.level,order:t.order,settings:t.settings,type:t.type};return e&&(o.actions=t.actions.map((t=>({id:t.id,isPreset:t.isPreset,userSelected:t.userSelected})))),o}_getActions(t){return this.actions.filter((e=>e.id===t.id))}_createAction(t){return{encodedValue:t.encodedValue,id:t.id,name:t.name,fullName:t.fullName??t.name,listName:t.listName??t.name,cssClass:t.cssClass??"",icons:t.icon??{},icon1:t.icon1??"",icon2:t.icon2??"",icon3:t.icon3??"",img:t.img??"",info1:{class:t?.info1?.class??"",text:t?.info1?.text??"",title:t?.info1?.title??""},info2:{class:t?.info2?.class??"",text:t?.info2?.text??"",title:t?.info2?.title??""},info3:{class:t?.info3?.class??"",text:t?.info3?.text??"",title:t?.info3?.title??""},isAction:!0,isItem:t.isitem??null,isPreset:t.isPreset??!1,userSelected:t.userSelected??!0,systemSelected:t.systemSelected??!0,selected:!!t.systemSelected&&(t.userSelected??t.systemSelected??!0)}}async updateActions(t,e){const o=this._getGroup(e),i=o.actions,s=[];for(const e of t){if(e.id.includes("itemMacro"))continue;const t=o.actions.find((t=>t.id===e.id));if(t){const e={...t,userSelected:!0};s.push(e)}else{const t=this.availableActions.find((t=>t.id===e.id));if(t){const e={...t,userSelected:!0};s.push(e)}}}for(const e of i){if(!e.id||e?.id.includes("itemMacro"))continue;if(!t.find((t=>t.id===e.id))&&e.isPreset){const t={...e,userSelected:!1};s.push(t)}}e.settings.sort&&s.sort(((t,e)=>t.name.localeCompare(e.name))),o.actions=s}_addToAvailableActions(t){for(const e of t){this.availableActions.find((t=>t.id===e.id))||this.availableActions.push(e)}}async _sortAvailableActions(){this.availableActions.sort(((t,e)=>t.listName.localeCompare(e.listName)))}async getAvailableActions(){return this.availableActions.map((t=>this._toActionTagifyEntry(t)))}async getSelectedActions(t){const e=this._getGroup(t);if(e)return e.actions.filter((t=>!0===t.selected)).map((t=>this._toActionTagifyEntry(t)))}async getSelectedGroups(t={}){t.isSelected=!0,t.level=(t.level||0)+1;return this._getGroups(t)?.map((t=>this._toGroupTagifyEntry(t)))??[]}async getAvailableGroups(t){return[...await this._getDerivedGroups(t),...await this._getSystemGroups(),...await this._getCompendiumGroups(),...await this._getMacroGroups()]}async _getCompendiumGroups(){return game.packs.filter((t=>s.includes(t.documentName)&&(!t.private||game.user.isGM))).map((t=>({id:t.metadata.id.replace(".","-"),listName:`Group: ${t.metadata.label}`,name:t.metadata.label,type:"core"}))).map((t=>this._toGroupTagifyEntry(t)))}async _getDerivedGroups(t){return this._getGroups({nestId:t?.nestId,type:r.SYSTEM_DERIVED})?.map((t=>this._toGroupTagifyEntry(t)))??[]}async _getMacroGroups(){return[this._toGroupTagifyEntry({id:"macros",listName:`Group: ${Utils.i18n("tokenActionHud.macros")}`,name:Utils.i18n("tokenActionHud.macros"),type:"core"})]}async _getSystemGroups(){return Object.values(this.defaultGroups).map((t=>this._toGroupTagifyEntry(t)))}async addGroup(t,e,o=!1){if(t.type=t?.type??"system-derived",t.style=t?.style??"list",!e?.id&&!e?.nestId)return;const i=this._getGroups(e);if(i?.length)for(const e of i){const i=`${e.nestId}_${t.id}`,s=this._getGroups({...t,nestId:i});if(s.length){if(o)for(const e of s)t.info&&(Object.assign(t,{...t.info}),delete t.info),Object.assign(e,{...t})}else{const o=this._createGroup({...t,nestId:i});"tab"===o.settings.style?e.groups.tabs.push(o):e.groups.lists.push(o),this.groups[o.nestId]=o}}}async updateGroup(t,e=null){t.type=t?.type??"system-derived";const updateExistingGroups=e=>{for(const o of e)t.info&&(Object.assign(t,{...t.info}),delete t.info),Object.assign(o,{...t})};if(e){const o=this._getGroups(e);for(const e of o){const o=`${e.nestId}_${t.id}`;updateExistingGroups(this._getGroups({...t,nestId:o}))}}else{updateExistingGroups(this._getGroups(t))}}removeGroup(t){!t?.nestId&&t?.id&&Utils.deleteGroupsById(this.hud.groups,t.id);const e=this._getGroups(t);if(e?.length)for(const o of e)delete this.groups[o.nestId],t?.nestId&&Utils.deleteGroupByNestId(this.hud.groups,o.nestId)}async addGroupInfo(t){const e=t?.id,o=t?.info;if(!e||!o)return;this._getGroups(t).forEach((t=>{t.info1=o.info1,t.info2=o.info2,t.info3=o.info3}))}async addActions(t,e){if(!t.length)return;const o=t.map((t=>this._createAction(t)));if(this._addToAvailableActions(o),!e?.id)return;const i=this._getGroups(e);if(i)for(const t of i){const e=t.actions??[],i=[];for(const t of e){const e=o.find((e=>e.id===t.id));if(e){const o=e.systemSelected??t.systemSelected,i=t.userSelected??e.userSelected;Object.assign(t,this._createAction({...e,isPreset:!0,systemSelected:o,userSelected:i}))}else if(!t.selected&&t.isPreset){const e=!1;Object.assign(t,this._createAction({...t,systemSelected:e}))}}for(const t of o){e.find((e=>e.id===t.id))||i.push(this._createAction({...t,isPreset:!0}))}t.settings.sort&&i.sort(((t,e)=>t.name.localeCompare(e.name))),t.actions.push(...i)}}async _setCharacterLimit(){const t=this._getGroups({level:1});for(const e of t){const t=e?.settings?.characterCount,o=this._getGroups({nestId:e.nestId});for(const e of o){const o=e.actions;if(!o||0===o?.length)continue;const i=e?.settings?.characterCount,s=i>=0?t:i;if(!(!s&&0!==s||s<0))for(const t of o)t.name.length<=s||(t.name=0!==s?t.name.split(" ").map((t=>t.slice(0,s))).join(" "):"")}}}addFurtherActionHandler(t){Logger.debug("Adding further action handler...",{handler:t}),this.furtherActionHandlers.push(t)}isLinkedCompendium(t){return!!this._getGroup({id:t})}_toGroupTagifyEntry(t){return{id:t.id,name:t.name,type:t.type,value:t.listName??t.name}}_toActionTagifyEntry(t){return{id:t.id,name:t.name,type:"action",value:t.listName??t.name}}async addActionsToActionList(t,e){globalThis.logger.warn("Token Action HUD | ActionHandler.addActionsToActionList is deprecated. Use ActionHandler.addActions"),await this.addActions(t,e)}async addSubcategoryInfo(t){globalThis.logger.warn("Token Action HUD | ActionHandler.addSubcategoryInfo is deprecated. Use ActionHandler.addGroupInfo"),this.addGroupInfo(t)}async addSubcategoryToActionList(t,e,o=!1){globalThis.logger.warn("Token Action HUD | ActionHandler.addSubcategoryToActionList is deprecated. Use ActionHandler.addGroup"),this.addGroup(e,t,o)}sortItems(t){return globalThis.logger.warn("ActionHandler.sortItems is deprecated. Use Utils.sortItems"),Utils.sortItems(t)}sortItemsByName(t){return globalThis.logger.warn("ActionHandler.sortItemsByName is deprecated. Use Utils.sortItemsByName"),Utils.sortItemsByName(t)}}class ActionListExtender extends ActionHandler{extendActionList(){}}class MigrationManager{constructor(t,e){this.systemModuleId=t,this.socket=e}async init(){await this._migrateGroups()}async _migrateGroups(){if(Utils.getUserFlag("categories"))try{Utils.getUserFlag("default")&&Utils.unsetUserFlag("default");const e=Utils.getUserFlag("categories");if(e){const o=Utils.getSubcategories(e);if(o&&Object.keys(o).length){const t={};for(const e of Object.values(o))if("system-derived"!==e.type){const o=Utils.deepClone(e);Object.hasOwn(o,"actions")&&delete o.actions,Object.hasOwn(o,"subcategories")&&delete o.subcategories,Object.hasOwn(o,"hasDerivedSubcategories")&&delete o.hasDerivedSubcategories,Object.hasOwn(o,"advancedCategoryOptions")&&(o.settings=o.advancedCategoryOptions,delete o.advancedCategoryOptions),t[o.nestId]=o}await this.socket.executeAsGM("saveData","user",game.userId,t)}if(game.user.isGM){const e=game.actors.filter((e=>e.getFlag(t.ID,"categories")));for(const o of e){const e=o.getFlag(t.ID,"categories"),i=Utils.getSubcategories(e);if(i&&Object.keys(i).length){const e={};for(const t of Object.values(i)){const o=Utils.deepClone(t);Object.hasOwn(o,"subcategories")&&delete o.subcategories,Object.hasOwn(o,"hasDerivedSubcategories")&&delete o.hasDerivedSubcategories,Object.hasOwn(o,"advancedCategoryOptions")&&(o.settings=o.advancedCategoryOptions,delete o.advancedCategoryOptions),e[o.nestId]=o}await this.socket.executeAsGM("saveData","actor",o.id,e),o.unsetFlag(t.ID,"categories")}}const o=game.canvas.tokens.objects.children.filter((e=>e.actor?.getFlag(t.ID,"categories")));for(const e of o){const o=e.actor.getFlag(t.ID,"categories"),i=Utils.getSubcategories(o);if(i&&Object.keys(i).length){const o={};for(const t of Object.values(i)){const e=Utils.deepClone(t);Object.hasOwn(e,"subcategories")&&delete e.subcategories,Object.hasOwn(e,"hasDerivedSubcategories")&&delete e.hasDerivedSubcategories,Object.hasOwn(e,"advancedCategoryOptions")&&(e.settings=e.advancedCategoryOptions,delete e.advancedCategoryOptions),o[e.nestId]=e}await this.socket.executeAsGM("saveData","actor",e.actor.id,o),e.actor.unsetFlag(t.ID,"categories")}}}Utils.unsetUserFlag("categories")}Logger.info("Successfully migrated flags",!0)}catch(t){Logger.error("Failed to migrate flags",!0),Logger.debug(t.message,t)}}}class RollHandler{actor=null;token=null;delimiter="|";preRollHandlers=[];throwInvalidValueErr(t){throw new Error(`Error handling button click: ${t}`)}async handleActionEvent(t,e){Logger.debug(`Handling event for action [${e}]`,{event:t}),this.registerKeyPresses(t);let o=!1;this.preRollHandlers.forEach((i=>{o||(o=i.prehandleActionEvent(t,e))})),o||(this._isGenericAction(e)?await this._handleGenericAction(e):this.doHandleActionEvent(t,e))}doHandleActionEvent(t,e){}addPreRollHandler(t){Logger.debug(`Adding pre-roll handler ${t.constructor.name}`),this.preRollHandlers.push(t)}registerKeyPresses(t){this.rightClick=this.isRightClick(t),this.ctrl=this.isCtrl(t),this.alt=this.isAlt(t),this.shift=this.isShift(t)}doRenderItem(t,e){t||(t=this.actor);Utils.getItem(t,e).sheet.render(!0)}isRenderItem(){return Utils.getSetting("renderItemOnRightClick")&&this.rightClick&&!(this.alt||this.ctrl||this.shift)}isRightClick(t){return 2===t?.originalEvent?.button}isAlt(t){const e=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT);return t.altKey&&!e?(Logger.debug("Emulating LEFT ALT key press"),KeyboardManager.emulateKeypress(!1,"AltLeft",{altKey:!0,force:!0}),game.keyboard.downKeys.add("AltLeft"),!0):e}isCtrl(t){const e=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL);return t.ctrlKey&&!e?(Logger.debug("Emulating LEFT CTRL key press"),KeyboardManager.emulateKeypress(!1,"ControlLeft",{ctrlKey:!0,force:!0}),game.keyboard.downKeys.add("ControlLeft"),!0):e}isShift(t){const e=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT);return t.shiftKey&&!e?(Logger.debug("Emulating LEFT SHIFT key press"),KeyboardManager.emulateKeypress(!1,"ShiftLeft",{shiftKey:!0,force:!0}),game.keyboard.downKeys.add("ShiftLeft"),!0):e}_isGenericAction(t){const e=t.split("|"),o=e[0],i=e[1];return"utility"===o&&i.includes("toggle")}async _handleGenericAction(t){const e=t.split("|")[1],o=Utils.getFirstControlledToken();"toggleVisibility"===e&&await o.toggleVisibility(),"toggleCombat"===e&&await o.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHud")}}class PreRollHandler extends RollHandler{prehandleActionEvent(t,e){return!1}}class CustomStyleForm extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{title:Utils.i18n("tokenActionHud.settings.customStyle.form.title"),template:`/modules/${t.ID}/templates/custom-style-form.hbs`,id:"token-action-hud-core-settings",width:600,height:"auto",closeOnSubmit:!0})}constructor(...t){super(t)}getData(){return this.data={backgroundColor:Utils.getSetting("backgroundColor",a.backgroundColor.default),buttonHeight:Utils.getSetting("buttonHeight",a.buttonHeight.default),buttonBackgroundColor:Utils.getSetting("buttonBackgroundColor",a.buttonBackgroundColor.default),buttonHoverBackgroundColor:Utils.getSetting("buttonHoverBackgroundColor",a.buttonHoverBackgroundColor.default),buttonToggleActiveBackgroundColor:Utils.getSetting("buttonToggleActiveBackgroundColor",a.buttonToggleActiveBackgroundColor.default),buttonToggleHoverBackgroundColor:Utils.getSetting("buttonToggleHoverBackgroundColor",a.buttonToggleHoverBackgroundColor.default),buttonTextColor:Utils.getSetting("buttonTextColor",a.buttonTextColor.default),buttonHoverTextColor:Utils.getSetting("buttonHoverTextColor",a.buttonHoverTextColor.default),buttonToggleActiveTextColor:Utils.getSetting("buttonToggleActiveTextColor",a.buttonToggleActiveTextColor.default),buttonToggleHoverTextColor:Utils.getSetting("buttonToggleHoverTextColor",a.buttonToggleHoverTextColor.default),buttonBorderPrimaryColor:Utils.getSetting("buttonBorderPrimaryColor",a.buttonBorderPrimaryColor.default),buttonBorderSecondaryColor:Utils.getSetting("buttonBorderSecondaryColor",a.buttonBorderSecondaryColor.default),buttonHoverBorderPrimaryColor:Utils.getSetting("buttonHoverBorderPrimaryColor",a.buttonHoverBorderPrimaryColor.default),buttonHoverBorderSecondaryColor:Utils.getSetting("buttonHoverBorderSecondaryColor",a.buttonHoverBorderSecondaryColor.default),buttonToggleActiveBorderPrimaryColor:Utils.getSetting("buttonToggleActiveBorderPrimaryColor",a.buttonToggleActiveBorderPrimaryColor.default),buttonToggleActiveBorderSecondaryColor:Utils.getSetting("buttonToggleActiveBorderSecondaryColor",a.buttonToggleActiveBorderSecondaryColor.default),buttonToggleHoverBorderPrimaryColor:Utils.getSetting("buttonToggleHoverBorderPrimaryColor",a.buttonToggleHoverBorderPrimaryColor.default),buttonToggleHoverBorderSecondaryColor:Utils.getSetting("buttonToggleHoverBorderSecondaryColor",a.buttonToggleHoverBorderSecondaryColor.default),textPrimaryColor:Utils.getSetting("textPrimaryColor",a.textPrimaryColor.default),textSecondaryColor:Utils.getSetting("textSecondaryColor",a.textSecondaryColor.default),textTertiaryColor:Utils.getSetting("textTertiaryColor",a.textTertiaryColor.default),textHoverPrimaryColor:Utils.getSetting("textHoverPrimaryColor",a.textHoverPrimaryColor.default),textHoverSecondaryColor:Utils.getSetting("textHoverSecondaryColor",a.textHoverSecondaryColor.default),textHoverTertiaryColor:Utils.getSetting("textHoverTertiaryColor",a.textHoverTertiaryColor.default)},this.data}activateListeners(t){super.activateListeners(t);t.find("#tah-custom-style-reset-button").on("click",this._reset.bind(this)),ColorPicker&&ColorPicker.install()}_reset(){for(const[t,e]of Object.entries(a))Utils.setSetting(t,e.default),document.querySelector(":root").style.setProperty(e.cssProperty,e.default);this.render(!0)}_updateObject(t,e){for(const[t,o]of Object.entries(e)){const e=a[t];o!==this.data[t]&&(Utils.setSetting(t,o),document.querySelector(":root").style.setProperty(e.cssProperty,o))}}}function onChangeFunction(t){game.tokenActionHud&&game.tokenActionHud.updateSettings()}Hooks.on("init",(async()=>{game.keybindings.register(t.ID,"toggleHud",{name:Utils.i18n("tokenActionHud.toggleHud"),editable:[{key:"KeyH",modifiers:[]}],onDown:()=>{game.tokenActionHud.toggleHud()}})}));const registerSettings=function(e,o){game.settings.register(t.ID,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(t.ID,"style",{name:Utils.i18n("tokenActionHud.settings.style.name"),hint:Utils.i18n("tokenActionHud.settings.style.hint"),scope:"client",config:!0,type:String,default:"foundryVTT",choices:{compact:"Compact",dorakoUI:"Dorako UI",foundryVTT:"Foundry VTT",highContrast:"High Contrast",pathfinder:"Pathfinder",custom:"Custom"},onChange:t=>{Utils.switchCSS(t)}}),game.settings.registerMenu(t.ID,"customStyle",{name:Utils.i18n("tokenActionHud.settings.customStyle.name"),label:Utils.i18n("tokenActionHud.settings.customStyle.label"),hint:Utils.i18n("tokenActionHud.settings.customStyle.hint"),icon:"fas fa-palette",type:CustomStyleForm,restricted:!0,scope:"client"}),game.settings.register(t.ID,"direction",{name:Utils.i18n("tokenActionHud.settings.direction.name"),hint:Utils.i18n("tokenActionHud.settings.direction.hint"),scope:"client",config:!0,type:String,default:"auto",choices:{auto:Utils.i18n("tokenActionHud.settings.direction.choices.auto"),up:Utils.i18n("tokenActionHud.settings.direction.choices.up"),down:Utils.i18n("tokenActionHud.settings.direction.choices.down")},onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"grid",{name:Utils.i18n("tokenActionHud.settings.grid.name"),hint:Utils.i18n("tokenActionHud.settings.grid.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"scale",{name:Utils.i18n("tokenActionHud.settings.scale.name"),hint:Utils.i18n("tokenActionHud.settings.scale.hint"),scope:"client",config:!0,type:Number,range:{min:.5,max:2,step:.05},default:1,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"drag",{name:Utils.i18n("tokenActionHud.settings.drag.name"),hint:Utils.i18n("tokenActionHud.settings.drag.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"enable",{name:Utils.i18n("tokenActionHud.settings.enable.name"),hint:Utils.i18n("tokenActionHud.settings.enable.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"rollHandler",{name:Utils.i18n("tokenActionHud.settings.rollHandler.name"),hint:Utils.i18n("tokenActionHud.settings.rollHandler.hint"),scope:"world",config:!0,type:String,choices:o,default:"core",onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"allow",{name:Utils.i18n("tokenActionHud.settings.allow.name"),hint:Utils.i18n("tokenActionHud.settings.allow.hint"),scope:"world",config:!0,type:String,choices:{4:Utils.i18n("tokenActionHud.settings.allow.choices.4"),3:Utils.i18n("tokenActionHud.settings.allow.choices.3"),2:Utils.i18n("tokenActionHud.settings.allow.choices.2"),1:Utils.i18n("tokenActionHud.settings.allow.choices.1")},default:1,requiresReload:!0}),game.settings.register(t.ID,"enableCustomization",{name:Utils.i18n("tokenActionHud.settings.enableCustomization.name"),hint:Utils.i18n("tokenActionHud.settings.enableCustomization.hint"),scope:"world",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"alwaysShowHud",{name:Utils.i18n("tokenActionHud.settings.alwaysShowHud.name"),hint:Utils.i18n("tokenActionHud.settings.alwaysShowHud.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"displayCharacterName",{name:Utils.i18n("tokenActionHud.settings.displayCharacterName.name"),hint:Utils.i18n("tokenActionHud.settings.displayCharacterName.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"displayIcons",{name:Utils.i18n("tokenActionHud.settings.displayIcons.name"),hint:Utils.i18n("tokenActionHud.settings.displayIcons.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"clickOpenCategory",{name:Utils.i18n("tokenActionHud.settings.clickOpenCategory.name"),hint:Utils.i18n("tokenActionHud.settings.clickOpenCategory.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"renderItemOnRightClick",{name:Utils.i18n("tokenActionHud.settings.renderItemOnRightClick.name"),hint:Utils.i18n("tokenActionHud.settings.renderItemOnRightClick.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{onChangeFunction()}}),game.modules.get("itemacro")?.active&&game.settings.register(t.ID,"itemMacro",{name:Utils.i18n("tokenActionHud.settings.itemMacro.name"),hint:Utils.i18n("tokenActionHud.settings.itemMacro.hint"),scope:"client",config:!0,type:String,choices:{both:Utils.i18n("tokenActionHud.settings.itemMacro.choices.both"),itemMacro:Utils.i18n("tokenActionHud.settings.itemMacro.choices.itemMacro"),original:Utils.i18n("tokenActionHud.settings.itemMacro.choices.original")},default:"both",onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"activeCssAsText",{name:Utils.i18n("tokenActionHud.settings.activeCssAsText.name"),hint:Utils.i18n("tokenActionHud.settings.activeCssAsText.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"debug",{name:Utils.i18n("tokenActionHud.settings.debug.name"),hint:Utils.i18n("tokenActionHud.settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{onChangeFunction()}}),game.settings.register(t.ID,"reset",{name:Utils.i18n("tokenActionHud.settings.reset.name"),hint:Utils.i18n("tokenActionHud.settings.reset.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{t&&(Utils.setSetting("reset",!1),game.tokenActionHud.reset())}}),function registerCustomStyleSettings(){for(const[e,o]of Object.entries(a))game.settings.register(t.ID,e,{scope:"client",config:!1,type:o.type,default:o.default})}(),e.doRegisterSettings(onChangeFunction),Logger.debug("Available roll handlers",{rollHandlers:o})};class ItemMacroActionListExtender extends ActionListExtender{constructor(t){super(t),this.actionHandler=t,this.actor=this.actionHandler.actor,this.token=this.actionHandler.token}extendActionList(){if(!this.actor)return;const t=this.actor.items.filter((t=>t.flags?.itemacro?.macro?.command));let e;if(e=Utils.isModuleActive("midi-qol")?t.filter(this._isUnsupportedByMidiQoL).map((t=>t.id)):t.map((t=>t.id)),!e)return;if(0===e.length)return;const o=Utils.getSetting("itemMacro");if("original"===o)return;const i="itemMacro"===o;this.actionHandler.groups.forEach((t=>{this._addGroupActions(e,t,i)}))}_addGroupActions(t,e,o){if(!e?.actions?.length)return;const i=[];e.actions.forEach((s=>{if(!t.includes(s.id))return;const n=e.actions.find((t=>t.id===`itemMacro+${s.id}`)),a=n??s;n&&(o=!0);const r=this._createItemMacroAction(s,a,o);o||i.push(r)})),this._addActions(i,e)}_createItemMacroAction(t,e,o){const i=o?e:Utils.deepClone(t);return i.encodedValue=`itemMacro${t.encodedValue.substr(t.encodedValue.indexOf("|"))}`,i.id=`itemMacro+${t.id}`,i.fullName=t.fullName,i.listName=`Item Macro: ${t.fullName}`,i.name=t.name,i.itemMacroIcon=`<i class="${l.ICON}" title="${l.TOOLTIP}"></i>`,i}_addActions(t,e){t.forEach((t=>{const o=e.actions.findIndex((e=>e.id===t.id))+1;e.actions.splice(o,0,t)}))}_isUnsupportedByMidiQoL(t){return!t.getFlag("midi-qol","onUseMacroName")}}class CompendiumMacroPreHandler extends PreRollHandler{prehandleActionEvent(t,e){const o=e.split("|");if(o.length<2)return!1;let s=null,n=null,a=null;if(2===o.length&&(s=o[0],a=o[1]),3===o.length&&(s=o[0],n=o[1],a=o[2]),!i.includes(s))return!1;switch(s){case"compendiumEntry":this._handleCompendium(n,a);break;case"compendiumMacro":this._handleMacroCompendium(n,a);break;case"compendiumPlaylist":this._handlePlaylistCompendium(n,a);break;case"macro":this._handleMacro(a);break;default:return!1}return!0}_handleCompendium(t,e){game.packs.get(t).getDocument(e).then((t=>t.sheet.render(!0)))}_handleMacroCompendium(t,e){game.packs.get(t).getDocument(e).then((t=>t.execute()))}async _handlePlaylistCompendium(t,e){const o=game.packs.get(t),i=e.split(">"),s=i[0],n=i[1],a=(await o.getDocument(s)).sounds.find((t=>t._id===n));AudioHelper.play({src:a.path},{})}_handleMacro(t){game.macros.find((e=>e.id===t)).execute()}}class ItemMacroPreRollHandler extends PreRollHandler{prehandleActionEvent(t,e){const o=e.split("|");if(2!==o.length)return!1;const i=o[0],s=o[1];return"itemMacro"===i&&(this.isRenderItem()?(this.doRenderItem(this.actor,s),!0):this._tryExecuteItemMacro(s))}_tryExecuteItemMacro(t){const e=Utils.getItem(this.actor,t);try{e.executeMacro()}catch(t){return Logger.debug("ItemMacro Error",t),!1}return!0}}class SystemManager{constructor(){this.coreModuleId=t.ID}doGetActionHandler(){}doGetRollHandler(t){}getAvailableRollHandlers(){}doRegisterSettings(t){}async doRegisterDefaultFlags(){}async registerDefaultFlags(){await Utils.unsetUserFlag("default");const t=await this.doRegisterDefaultFlags()??[];t&&(t?.categories&&globalThis.logger.warn("Token Action HUD | SystemManager.doRegisterDefaultFlags expects 'layout' to be returned instead of 'categories'"),t?.subcategories&&globalThis.logger.warn("Token Action HUD | SystemManager.doRegisterDefaultFlags expects 'groups' to be returned instead of 'subcategories'"),game.tokenActionHud.defaults=t)}async getActionHandler(){const t=this.doGetActionHandler();return this.addActionExtenders(t),t}addActionExtenders(t){Utils.isModuleActive("itemacro")&&t.addFurtherActionHandler(new ItemMacroActionListExtender(t))}getRollHandler(){let t=Utils.getSetting("rollHandler");"core"===t||Utils.isModuleActive(t)||(Logger.error(t,Utils.i18n("tokenActionHud.handlerNotFound")),t="core",Utils.setSetting("rollHandler",t));const e=this.doGetRollHandler(t);return this.addPreHandlers(e),e}addPreHandlers(t){t.addPreRollHandler(new CompendiumMacroPreHandler),Utils.isModuleActive("itemacro")&&t.addPreRollHandler(new ItemMacroPreRollHandler)}registerSettings(){const t=this.getAvailableRollHandlers();registerSettings(this,t)}static addHandler(t,e){if(Utils.isModuleActive(e)){const o=Utils.getModuleTitle(e);mergeObject(t,{[e]:o})}}}class TagDialog extends FormApplication{tagify=null;dragSort=null;constructor(t){super(t,{title:t.title}),this.content=t.content,this.submit=t.submit,this.categoryId=null,this.subcategoryId=null}static get defaultOptions(){const e=super.defaultOptions,o={closeOnSubmit:!0,id:"token-action-hud-dialog",template:`modules/${t.ID}/templates/tagdialog.hbs`,width:500};return foundry.utils.mergeObject(e,o)}getData(t){return this.content}activateListeners(t){super.activateListeners(t);t.find("#tah-dialog-cancel").on("click",this.close.bind(this));t.find("#tah-dialog-reset-actions").on("click",this._resetActions)}static showDialog(t,e,o,i){this.nestId=t,TagDialog._prepareHook(e);new TagDialog({title:o.title,content:o.content,submit:i}).render(!0)}static _prepareHook(t){Hooks.once("renderTagDialog",((e,o,i)=>{o.css("height","auto");const s=o.find('select[id="token-action-hud-index"]');s.length>0&&(s.css("background","#fff"),s.css("color","#000"));const n=o.find('input[class="token-action-hud-taginput"]');if(n.length>0){const a={delimiters:";",maxTags:"Infinity",dropdown:{maxItems:500,classname:"tags-look",enabled:0,closeOnSelect:!1}};function onDragEnd(t){TagDialog.tagify.updateValueByDOMTags()}t.available&&(a.whitelist=t.available),TagDialog.tagify=new Tagify(n[0],a),TagDialog.dragSort=new DragSort(TagDialog.tagify.DOM.scope,{selector:"."+TagDialog.tagify.settings.classNames.tag,callbacks:{dragEnd:onDragEnd}});const r=$(document).find(".tagify");r.css("background","#fff"),r.css("color","#000"),t.selected&&TagDialog.tagify.addTags(t.selected);o.find("#tah-dialog-clear-tags").on("click",TagDialog.tagify.removeAllTags.bind(TagDialog.tagify))}}))}async _resetActions(){new Dialog({title:Utils.i18n("tokenActionHud.tagDialog.resetActions.dialog.title"),content:`<p>${Utils.i18n("tokenActionHud.tagDialog.resetActions.dialog.content")}</p>`,buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:Utils.i18n("tokenActionHud.tagDialog.resetActions.dialog.buttons.yes"),callback:async()=>{await game.tokenActionHud.resetActorData(),Logger.info("Actions reset",!0)}},no:{icon:'<i class="fas fa-times"></i>',label:Utils.i18n("tokenActionHud.tagDialog.resetActions.dialog.buttons.no")}}}).render(!0)}_onKeyDown(t){if("Escape"===t.key&&!t.target.className.includes("tagify"))return t.preventDefault(),t.stopPropagation(),this.close();if("Enter"===t.key&&this.data.default&&!t.target.className.includes("tagify")){t.preventDefault(),t.stopPropagation();const e=this.data.buttons[this.data.default];return this.submit(e)}}async _updateObject(t,e){const o=TagDialog.tagify.value.map((t=>(t.id=t.id??t.value.slugify({replacement:"-",strict:!0}),{id:t.id,listName:t.value,name:t.name??t.value,type:t.type})));await this.submit(o,e)}}class TagDialogHelper{static async showHudDialog(t){const e={available:[]};e.selected=await t.getSelectedGroups();const o=await Utils.getSetting("grid"),i={title:Utils.i18n("tokenActionHud.tagDialog.hudDialogTitle"),content:{topLabel:Utils.i18n("tokenActionHud.tagDialog.hudDialogDescription"),placeholder:Utils.i18n("tokenActionHud.tagDialog.tagPlaceholder"),clearButtonText:Utils.i18n("tokenActionHud.tagDialog.clearButton"),indexExplanationLabel:Utils.i18n("tokenActionHud.pushLabelExplanation"),settings:{grid:o},level:"hud"}};TagDialog.showDialog(null,e,i,(async(e,o)=>{const i=o?.grid;await t.updateGroups(e,{level:0}),await t.saveGroups({saveActor:!0,saveUser:!0}),await Utils.setSetting("grid",i),Hooks.callAll("forceUpdateTokenActionHud")}))}static async showGroupDialog(t,e){const{nestId:o,name:i,level:s}=e,n={};n.available=await t.getAvailableGroups({nestId:o,level:s}),n.selected=await t.getSelectedGroups({nestId:o,level:s});const a={title:Utils.i18n("tokenActionHud.tagDialog.groupDialogTitle")+` (${i})`,content:{topLabel:Utils.i18n("tokenActionHud.tagDialog.groupDialogDescription"),placeholder:Utils.i18n("tokenActionHud.tagDialog.tagPlaceholder"),clearButtonText:Utils.i18n("tokenActionHud.tagDialog.clearButton"),settings:await t.getGroupSettings(e),level:"category"}};TagDialog.showDialog(o,n,a,(async(o,i)=>{o=o.map((t=>(t.id=t.id??t.name.slugify({replacement:"-",strict:!0}),t.type=t.type??"custom",{id:t.id,listName:t.listName,name:t.name,type:t.type})));const s=i?.characterCount,n=i?.customWidth,a=i?.grid,r=i?.image,l=i?.showTitle,c=i?.sort;e.settings={characterCount:s,customWidth:n,grid:a,image:r,showTitle:l,sort:c},await t.updateGroups(o,e),await t.saveGroups({saveActor:!0,saveUser:!0}),Hooks.callAll("forceUpdateTokenActionHud")}))}static async showActionDialog(t,e){const{nestId:o,name:i,level:s}=e,n={},a=await t.getAvailableActions(e),r=await t.getAvailableGroups({nestId:o,level:s});n.available=[...a,...r];const l=await t.getSelectedActions(e),c=await t.getSelectedGroups({nestId:o,level:s});n.selected=[...l,...c];const d={title:`${Utils.i18n("tokenActionHud.tagDialog.actionDialogTitle")} (${i})`,content:{topLabel:Utils.i18n("tokenActionHud.tagDialog.actionDialogDescription"),placeholder:Utils.i18n("tokenActionHud.tagDialog.tagPlaceholder"),clearButtonText:Utils.i18n("tokenActionHud.tagDialog.clearButton"),indexExplanationLabel:Utils.i18n("tokenActionHud.blockListLabel"),settings:await t.getGroupSettings(e),level:"subcategory"}};TagDialog.showDialog(o,n,d,(async(o,i)=>{const s=[],n=[];for(const t of o)"action"===t.type?n.push(t):s.push(t);const a=i?.characterCount,r=i?.collapse,l=i?.grid,c=i?.image,d=i?.showTitle,u=i?.sort,g=i?.style;e.settings={characterCount:a,collapse:r,grid:l,image:c,showTitle:d,sort:u,style:g},await t.updateGroups(s,e),await t.updateActions(n,e),await t.saveGroups({saveActor:!0,saveUser:!0}),Hooks.callAll("forceUpdateTokenActionHud")}))}}class CategoryResizer{direction=null;minCols=3;isCustomWidth=!1;settings=null;spacing=10;async resizeCategory(t,e,o,i){if(!e)return;if(this._resetVariables(),this.groupElement=e,await this._getGroupsElement(),!this.groupsElement)return;if(this.actionsElements=this.groupElement.querySelectorAll(".tah-actions"),0===this.actionsElements.length)return;this._resetGroupsElements(),this.direction=o;const s=this.groupElement.dataset.nestId;this.settings=await t.getGroupSettings({nestId:s,level:1}),this.availableWidth=this._getAvailableWidth(),this._getGroupElements();let n=!1;for(const e of this.groupElements){const o=e.querySelector(".tah-actions");if(!o)continue;const s=e.dataset.nestId,a=await t.getGroupSettings({nestId:s});i||this.settings?.grid||a?.grid?(n||(await this._getGridWidth(),n=!0),await this._resizeGrid(o)):await this._resize(o)}await this._setHeight()}_resetVariables(){this.actionsElements=null,this.availableHeight=null,this.availableWidth=null,this.direction=null,this.gridWidth=null,this.groupElement=null,this.groupElements=null,this.groupsElement=null,this.groupsElementPadding=null,this.groupsElementRect=null,this.isCustomWidth=!1,this.minCols=3,this.settings=null,this.spacing=10}_resetGroupsElements(){const t=this.groupElement.closest('.tah-tab-group[data-level="1"]').querySelectorAll(".tah-groups");this._resetCSS(t,{maxHeight:"",overflowY:""})}async _getGridWidth(){await this._resetCSS(this.actionsElements,{display:"",gridTemplateColumns:"",width:""});const t=[],e=[];for(const o of this.actionsElements){const i=o.querySelectorAll(".tah-action:not(.shrink)");for(const o of i){const i=o.getBoundingClientRect(),s=Math.round(parseFloat(i.width)+1||0),n=o.querySelector(".tah-action-button-text").getBoundingClientRect(),a=Math.round(parseFloat(n.width)||0);e.push(s),t.push({actionWidth:s,actionButtonTextWidth:a})}}let o=Math.ceil(1.1*Utils.median(e));for(const e of t){const t=o-(e.actionWidth-e.actionButtonTextWidth);t<30&&(o=o-t+30)}this.gridWidth=o}async _resizeGrid(t){if(!t)return;await this._assignCSS(t,{display:"",gridTemplateColumns:"",width:""});const e=t.querySelectorAll(".tah-action"),o=Math.ceil(Math.sqrt(e.length)),i=Math.floor(this.availableWidth/this.gridWidth),s={display:"grid",gridTemplateColumns:`repeat(${o>i?i:e.length<=this.minCols?e.length:o}, ${this.gridWidth}px)`};await this._assignCSS(t,s)}async _resize(t){if(!t)return;let e=500;if(this.isCustomWidth)e=this.availableWidth;else{let o=0,i=0;const s=t.querySelectorAll(".tah-action");if(s.length>0){let t=0;s.forEach(((e,o)=>{const i=e.getBoundingClientRect(),s=0===o?i.left-this.groupsElementRect.left:0,n=Math.ceil(parseFloat(i.width)+1||0);t+=n+s})),t>i&&(i=t,o=s.length)}i+=5*o-5,i+=this.groupsElementPadding;const n=i/o,a=5;let r=o<a?o:a;const l=Math.floor(this.availableWidth/n),c=Math.ceil(Math.sqrt(o));c>r&&c<=l&&(r=c),e=n*r,e>this.availableWidth&&(e=this.availableWidth),e<200&&(e=200)}const o={width:`${e}px`};await this._assignCSS(t,o)}_getAvailableWidth(){const t=this.settings?.customWidth;if(t)return this.isCustomWidth=!0,t;const e=canvas.screenDimensions[0],o=this.groupsElementRect.left,i=document.querySelector("#ui-right").clientWidth;return Math.floor((i>0?e-i:e)-this.spacing-o)}_getAvailableHeight(){const t=canvas.screenDimensions[1],e=this.groupsElementRect.bottom,o=this.groupsElementRect.top,i=("down"===this.direction?document.querySelector("#ui-bottom"):document.querySelector("#ui-top")).offsetHeight,s="down"===this.direction?t-o-i-this.spacing:e-i-this.spacing;return Math.floor(s<100?100:s)}async _getGroupsElement(){this.groupsElement=this.groupElement.querySelector(".tah-groups"),this.groupsElement&&(this.groupsElementRect=this.groupsElement.getBoundingClientRect(),this.groupsElementComputed=getComputedStyle(this.groupsElement),this.groupsElementPadding=Math.ceil(parseFloat(this.groupsElementComputed.paddingLeft)||0)+Math.ceil(parseFloat(this.groupsElementComputed.paddingRight)||0))}_getGroupElements(){this.groupElements=this.groupElement.querySelectorAll(".tah-group"),0===this.groupElements.length&&(this.groupElements=[this.groupElement])}async _setHeight(){requestAnimationFrame((()=>{this.availableHeight=this._getAvailableHeight();const t={maxHeight:`${this.availableHeight}px`,overflowY:"auto"};Object.assign(this.groupsElement.style,t)}))}async _assignCSS(t,e){t&&requestAnimationFrame((()=>{Object.assign(t.style,e)}))}async _resetCSS(t,e){for(const o of t)Object.assign(o.style,e)}}class TokenActionHud extends Application{hoveredGroups=[];defaults={};defaultHeight=200;defaultWidth=20;defaultLeftPos=150;defaultTopPos=80;leftPos=this.defaultLeftPos;topPos=this.defaultTopPos;defaultScale=1;refreshTimeout=null;rendering=!1;tokens=null;isUpdatePending=!1;isUpdating=!1;updateTimer=new Timer(20);constructor(t,e){super(),this.module=t,this.systemManager=e,this.autoDirection="down",this.direction="down",this.isAlwaysShow=!1,this.isClickOpen=!1,this.isCollapsed=!1,this.isCustomizationEnabled=!1,this.isDisplayIcons=!1,this.isDraggable=!1,this.isEnabled=!1,this.isHudEnabled=!1,this.isGrid=!1,this.isUnlocked=!1,this.style=null}async init(){this.direction=Utils.getSetting("direction"),this.isAlwaysShow=Utils.getSetting("alwaysShowHud"),this.isClickOpen=Utils.getSetting("clickOpenCategory"),this.isCollapsed=Utils.getUserFlag("isCollapsed"),this.isCustomizationEnabled=Utils.getSetting("enableCustomization"),this.isDebug=Utils.getSetting("debug"),this.isDisplayIcons=Utils.getSetting("displayIcons"),this.isDraggable=Utils.getSetting("drag"),this.isEnabled=Utils.getSetting("enable"),this.isHudEnabled=this._getHudEnabled(),this.isGrid=Utils.getSetting("grid"),this.isUnlocked=Utils.getUserFlag("isUnlocked"),this.style=Utils.getSetting("style"),await this.systemManager.registerDefaultFlags(),this.categoryResizer=new CategoryResizer,this.actionHandler=await this.systemManager.getActionHandler(),this.rollHandler=this.systemManager.getRollHandler()}updateSettings(){Logger.debug("Updating settings..."),this.updateRollHandler(),this.direction=Utils.getSetting("direction"),this.isAlwaysShow=Utils.getSetting("alwaysShowHud"),this.isClickOpen=Utils.getSetting("clickOpenCategory"),this.isCustomizationEnabled=Utils.getSetting("enableCustomization"),this.actionHandler.isCustomizationEnabled=this.isCustomizationEnabled,this.isDebug=Utils.getSetting("debug"),this.isDisplayIcons=Utils.getSetting("displayIcons"),this.actionHandler.displayIcons=this.isDisplayIcons,this.isDraggable=Utils.getSetting("drag"),this.isEnabled=Utils.getSetting("enable"),this.isHudEnabled=this._getHudEnabled(),this.isGrid=Utils.getSetting("grid"),this.style=Utils.getSetting("style"),Logger.debug("Settings updated");this.update({trigger:{type:"method",name:"TokenActionHud#updateSettings"}})}updateRollHandler(){this.rollHandler=this.systemManager.getRollHandler()}setTokens(t){this.tokens=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:`/modules/${t.ID}/templates/template.hbs`,id:"token-action-hud",classes:[],width:this.defaultWidth,height:this.defaultHeight,left:this.defaultLeftPos,top:this.defaultTopPos,scale:this.defaultScale,background:"none",popOut:!1,minimizable:!1,resizable:!1,title:"token-action-hud",dragDrop:[],tabs:[],scrollY:[]})}_getScale(){const t=parseFloat(Utils.getSetting("scale"));return t<.5?.5:t>2?2:t}getData(t={}){const e=super.getData();return e.hud=this.hud,e.id="token-action-hud",e.style=c[this.style].class,e.scale=this._getScale(),e.background="#00000000",Logger.debug("Application data",{data:e}),e}activateListeners(t){const e={actions:t.find(".tah-action"),buttons:t.find("#tah-buttons"),tabGroups:t.find(".tah-tab-group"),topGroupsSection:t.find("#tah-groups"),editHudButton:t.find("#tah-edit-hud"),groups:t.find(".tah-group"),subtitles:t.find(".tah-subtitle"),groupButtons:t.find(".tah-group-button"),collapseHudButton:t.find("#tah-collapse-hud"),expandHudButton:t.find("#tah-expand-hud"),unlockButton:t.find("#tah-unlock"),lockButton:t.find("#tah-lock")};this._bindGroupEvents(e),this._bindActionEvents(e),this._bindEditHudButton(e),this._bindLockUnlockButtons(e),this._bindCollapseExpandButtons(e)}postRender(){if(this.applySettings(),this.hoveredGroups.length)for(const t of this.hoveredGroups){const e=document.querySelector(`#${t}`);this.categoryResizer.resizeCategory(this.actionHandler,e,this.autoDirection,this.isGrid)}}_bindGroupEvents(t){const closeGroup=t=>{if(game.tokenActionHud.rendering)return;const e=this.isClickOpen?t.currentTarget.parentElement:t.currentTarget;e.classList.remove("hover"),this._clearHoveredGroup(e.id)},openGroup=async t=>{const e=this.isClickOpen?t.currentTarget.parentElement:t.currentTarget;e.classList.add("hover"),this.categoryResizer.resizeCategory(this.actionHandler,e,this.autoDirection,this.isGrid),this._setHoveredGroup(e.id)},toggleGroup=t=>{const e=t.currentTarget.parentElement;if(e.classList.contains("hover"))closeGroup(t);else{const o=e.parentElement.querySelectorAll(".tah-tab-group");for(const t of o)t.classList.remove("hover"),this._clearHoveredGroup(t.id);openGroup(t)}t.currentTarget.blur()};t.groupButtons.on("click",(t=>{this.bringToTop(),t.currentTarget.blur()})),this.isClickOpen?t.groupButtons.on("click",toggleGroup):(t.tabGroups.get().forEach((t=>{t.addEventListener("touchstart",toggleGroup,{passive:!0})})),t.tabGroups.hover(openGroup,closeGroup)),t.groupButtons.on("mousedown",(t=>this._dragEvent(t))),t.groupButtons.get().forEach((t=>{t.addEventListener("touchstart",(t=>this._dragEvent(t)),{passive:!0})}));const openGroupDialog=t=>{const e=t.currentTarget;if(!e?.parentElement?.dataset?.nestId)return;const o=e?.parentElement?.dataset?.nestId,i=e?.parentElement?.dataset?.name??e.innerText??e.outerText,s=parseInt(e?.parentElement?.dataset?.level)||null,n=e?.parentElement?.dataset?.type;TagDialogHelper.showGroupDialog(this.actionHandler,{nestId:o,name:i,level:s,type:n})};t.groupButtons.on("contextmenu",(t=>{this.isUnlocked&&"1"===t.currentTarget.parentElement.dataset.level&&openGroupDialog(t)}))}_bindActionEvents(t){const handleAction=t=>{let e=t.target;"BUTTON"!==e.tagName&&(e=t.currentTarget.children[0]);const o=e.value;try{this.rollHandler.handleActionEvent(t,o),e.blur()}catch(e){Logger.error(t)}},openActionDialog=t=>{const e=t.target.classList.contains("tah-button-text")?t.currentTarget:t.target.classList.contains("tah-subtitle-text")?t.target.parentElement:t.target;if(!e?.parentElement?.dataset?.nestId)return;const o=e?.parentElement?.dataset?.nestId,i=e?.parentElement?.dataset?.name??e.innerText??e.outerText,s=parseInt(e?.parentElement?.dataset?.level)||null,n=e?.parentElement?.dataset?.type;TagDialogHelper.showActionDialog(this.actionHandler,{nestId:o,name:i,level:s,type:n})},collapseExpandGroup=(t,e)=>{const o=t.target.classList.contains("tah-subtitle-text")?t.target.parentElement:t.target,i=o?.parentElement,s=i?.dataset?.nestId,n=o.closest(".tah-tab-group.hover"),a=i?.querySelector(".tah-groups"),r=o.querySelector(".tah-collapse-icon"),l=o.querySelector(".tah-expand-icon"),toggleGroupVisibility=()=>{a?.classList.toggle("tah-hidden"),r?.classList.toggle("tah-hidden"),l?.classList.toggle("tah-hidden")},saveGroupSettings=t=>{e&&this.actionHandler.saveGroupSettings({nestId:s,settings:{collapse:t}})};a?.classList.contains("tah-hidden")?(toggleGroupVisibility(),saveGroupSettings(!1),this.categoryResizer.resizeCategory(this.actionHandler,n,this.autoDirection,this.isGrid)):(toggleGroupVisibility(),saveGroupSettings(!0))};t.subtitles.on("contextmenu",(t=>{this.isUnlocked&&openActionDialog(t)})),t.subtitles.on("click",(t=>{t.target.classList.contains("tah-button-text")||collapseExpandGroup(t,this.isCustomizationEnabled)})),t.actions.on("click contextmenu",(t=>{t.preventDefault(),handleAction(t)})),t.groupButtons.on("contextmenu",(t=>{this.isUnlocked&&"1"!==t.currentTarget.parentElement.dataset.level&&openActionDialog(t)}))}_bindEditHudButton(t){t.editHudButton.on("click",(t=>{t.preventDefault(),t=t||window.event,TagDialogHelper.showHudDialog(this.actionHandler)}))}_bindLockUnlockButtons(t){const unlockHud=async e=>{e&&e.preventDefault();const o=e?.target||t.unlockButton;$(o).addClass("tah-hidden"),t.lockButton.removeClass("tah-hidden"),t.editHudButton.removeClass("tah-hidden"),t.topGroupsSection.addClass("tah-unlocked"),t.tabGroups.removeClass("tah-hidden"),t.groups.removeClass("tah-hidden"),t.subtitles.removeClass("disable-edit tah-hidden"),t.groupButtons.removeClass("disable-edit"),this.isUnlocked||(await Utils.setUserFlag("isUnlocked",!0),this.isUnlocked=!0)},lockHud=async(e=null)=>{e&&e.preventDefault();const o=e?.target||t.lockButton;$(o).addClass("tah-hidden"),t.unlockButton.removeClass("tah-hidden"),t.editHudButton.addClass("tah-hidden"),t.topGroupsSection.removeClass("tah-unlocked");for(const e of t.tabGroups){e.getElementsByClassName("tah-action").length>0||e.classList.add("tah-hidden")}for(const e of t.groups){e.getElementsByClassName("tah-action").length>0||e.classList.add("tah-hidden")}for(const e of t.subtitles)"false"===e.parentElement.dataset.showTitle&&e.classList.add("tah-hidden");t.groupButtons.addClass("disable-edit"),t.subtitles.addClass("disable-edit"),this.isUnlocked&&(await Utils.setUserFlag("isUnlocked",!1),this.isUnlocked=!1)};this.isUnlocked&&this.isCustomizationEnabled?unlockHud():lockHud(),this.isCustomizationEnabled||t.unlockButton.addClass("tah-hidden"),t.unlockButton.on("click",unlockHud),t.lockButton.on("click",lockHud)}_bindCollapseExpandButtons(t){const collapseHud=(e=null)=>{e&&(e.preventDefault(),e=e||window.event);const o=e?.target||t.collapseHudButton;$(o).addClass("tah-hidden"),t.expandHudButton.removeClass("tah-hidden"),t.topGroupsSection.addClass("tah-hidden"),t.buttons.addClass("tah-hidden"),this.isCollapsed||(Utils.setUserFlag("isCollapsed",!0),this.isCollapsed=!0)};this.isCollapsed&&collapseHud(),t.collapseHudButton.on("click",collapseHud),t.expandHudButton.on("click",(e=>{e.preventDefault(),e=e||window.event,$(e.target).addClass("tah-hidden"),t.collapseHudButton.removeClass("tah-hidden"),t.topGroupsSection.removeClass("tah-hidden"),t.buttons.removeClass("tah-hidden"),this.isCollapsed&&(Utils.setUserFlag("isCollapsed",!1),this.isCollapsed=!1)})),t.expandHudButton.on("mousedown",this._dragEvent),t.expandHudButton.get(0).addEventListener("touchstart",this._dragEvent,{passive:!0})}_dragEvent(t){if(!this.isDraggable)return;const e=document.getElementById("token-action-hud"),o=t.clientX??t.changedTouches[0].clientX,i=t.clientY??t.changedTouches[0].clientY;let s=0,n=0,a=o,r=i;const l=e.offsetTop,c=e.offsetLeft;let d=l,u=c;const mouseMoveEvent=t=>{const o=t.clientX??t.changedTouches[0].clientX,i=t.clientY??t.changedTouches[0].clientY;s=a-o,n=r-i,a=o,r=i,s===a&&n===r||(d-=n,u-=s,this.topPos=d,requestAnimationFrame((()=>{Object.assign(e.style,{left:`${u}px`,position:"fixed",top:`${d}px`})})))},mouseUpEvent=()=>{document.onmousemove=null,e.ontouchmove=null,document.onmouseup=null,e.ontouchend=null,d===l&&u===c||(this.topPos=d,this.applySettings(),Utils.setUserFlag("position",{top:d,left:u}),Logger.debug(`Set position to x: ${d}px, y: ${u}px`))};document.onmousemove=mouseMoveEvent,e.ontouchmove=mouseMoveEvent,document.onmouseup=mouseUpEvent,e.ontouchend=mouseUpEvent}_getAutoDirection(){return"up"===this.direction||"auto"===this.direction&&this.topPos>window.innerHeight/2?"up":"down"}applySettings(){this.autoDirection=this._getAutoDirection(),"up"===this.autoDirection?($(document).find(".tah-groups-container").removeClass("expand-down"),$(document).find(".tah-groups-container").addClass("expand-up"),$(document).find(".tah-groups-container").removeClass("expand-down"),$(document).find(".tah-groups-container").addClass("expand-up"),$(document).find("#tah-character-name").addClass("tah-hidden")):($(document).find(".tah-groups-container").addClass("expand-down"),$(document).find(".tah-groups-container").removeClass("expand-up"),$(document).find(".tah-groups-container").addClass("expand-down"),$(document).find(".tah-groups-container").removeClass("expand-up"),$(document).find("#tah-character-name").removeClass("tah-hidden"))}setPosition(){if(!this.hud)return;const t=$(document).find("#tah-character-name");t.length>0&&t.css("top",-t[0].getBoundingClientRect().height),canvas?.tokens?.placeables.find((t=>t.id===this.hud?.tokenId)),this._setPositionFromFlag(),this._restoreHoveredGroups(),this.rendering=!1}_setPositionFromFlag(){const t=Utils.getUserFlag("position");if(!t)return;const e=this.defaultLeftPos,o=this.defaultTopPos;return new Promise((i=>{const check=()=>{const s=document.getElementById("token-action-hud");s?(s.style.bottom=null,this.topPos=t.top<5||t.top>window.innerHeight+5?o:t.top,s.style.top=`${this.topPos}px`,this.leftPos=t.left<5||t.left>window.innerWidth+5?e:t.left,s.style.left=`${this.leftPos}px`,s.style.position="fixed",i()):setTimeout(check,30)};check()}))}_setPositionFromToken(t){return new Promise((e=>{!function check(t){const o=$("#token-action-hud");o?(o.css("bottom",null),o.css("left",t.worldTransform.tx+(t.width*canvas.dimensions.size+55)*canvas.scene._viewPosition.scale+"px"),o.css("top",t.worldTransform.ty+0+"px"),o.css("position","fixed"),e()):setTimeout(check,30)}(t)}))}async resetPosition(){Logger.debug("Resetting position..."),await Utils.setUserFlag("position",{top:this.defaultTopPos,left:this.defaultLeftPos}),Logger.debug(`Position reset to x: ${this.defaultTopPos}px, y: ${this.defaultLeftPos}px`)}_setHoveredGroup(t){this.hoveredGroups.length>10&&(this.hoveredGroups=[]),this.hoveredGroups.push(t)}_clearHoveredGroup(t){this.hoveredGroups=this.hoveredGroups.filter((e=>e!==t))}_restoreHoveredGroups(){if(this.hoveredGroups.length)for(const t of this.hoveredGroups){const e=$(`#${t}`);if(!e[0])return;if(this.isClickOpen){e.find(".tah-group-button")[0].click()}else e.mouseenter()}}async toggleHud(){const t=Utils.humanizeBinding("toggleHud");this.isEnabled?(this.close(),this.isEnabled=!1,await Utils.setSetting("enable",!1),Logger.info(game.i18n.format("tokenActionHud.settings.toggleHud.disabled",{binding:t}),!0)):(this.isEnabled=!0,await Utils.setSetting("enable",!0),Logger.info(game.i18n.format("tokenActionHud.settings.toggleHud.enabled",{binding:t}),!0),Hooks.callAll("forceUpdateTokenActionHud"))}async copy(t,e){await this._copyUserData(t,e)?Logger.info("HUD copied",!0):Logger.info("Copy HUD failed",!0)}async _copyUserData(t,e){if(!t||!e.length)return!1;Logger.debug("Copying user data...");const o=await game.tokenActionHud.socket.executeAsGM("getData","user",t);if("string"==typeof e)await game.tokenActionHud.socket.executeAsGM("saveData","user",e,o);else if(Array.isArray(e))for(const t of e)await game.tokenActionHud.socket.executeAsGM("saveData","user",t,o);return Logger.debug("User data copied"),!0}async reset(){await this.resetUserData(),this.resetPosition(),Logger.info("HUD reset",!0)}async resetActorData(){Logger.debug("Resetting actor data..."),await game.tokenActionHud.socket.executeAsGM("saveData","actor",this.actor.id,{}),Logger.debug("Actor data reset");this.update({trigger:{type:"method",name:"TokenActionHud#resetActorData"}})}async resetAllActorData(){Logger.debug("Resetting all actor data...");for(const t of game.actors)Logger.debug(`Resetting flags for actor [${t.id}]`,{actor:t}),await game.tokenActionHud.socket.executeAsGM("saveData","actor",t.id,{});Logger.debug("All actor data reset");this.update({trigger:{type:"method",name:"TokenActionHud#resetAllActorData"}})}async resetUserData(){Logger.debug("Resetting user data..."),await game.tokenActionHud.socket.executeAsGM("saveData","user",game.userId,{}),Logger.debug("User data reset"),this.actionHandler.resetActionHandler();this.update({trigger:{type:"method",name:"TokenActionHud#resetUserData"}})}async resetAllUserData(){Logger.debug("Resetting all user data...");for(const t of game.users)await game.tokenActionHud.socket.executeAsGM("saveData","user",t.id,{});Logger.debug("All user data reset"),this.actionHandler.resetActionHandler();this.update({trigger:{type:"method",name:"TokenActionHud#resetAllUserData"}})}update(t=null){this._updateHud(t)}async _updateHud(t){if(this.isUpdating)return;this.isUpdatePending&&await this.updateTimer.abort(),this.isUpdatePending=!0,await this.updateTimer.start(),this.isUpdatePending=!1,this.isUpdating=!0,Logger.debug("Updating hud...",t);const e=this.actor?.id,o=Utils.getControlledTokens(),i=this._getCharacter(o),s=o.length>1&&!i;if(!i&&!s||!this.isHudEnabled)return this.close(),this.hoveredGroups=[],Logger.debug("Hud update aborted as no character(s) found or hud is disabled"),void(this.isUpdating=!1);const n="controlToken"===t&&e!==this.actor?.id?{saveActor:!0}:{};if(this.hud=await this.actionHandler.buildHud(n),0===this.hud.length)return this.close(),this.hoveredGroups=[],Logger.debug("Hud update aborted as action list empty"),void(this.isUpdating=!1);this.rendering=!0,this.render(!0),this.isUpdating=!1,Hooks.callAll("tokenActionHudCoreHudUpdated",this.module),Logger.debug("Hud updated")}isValidTokenChange(t,e=null){return!e?.actorData?.flags&&(this.isAlwaysShow?this._isRelevantToken(t)||t.actorId===game.user.character?.id:this._isRelevantToken(t))}_isRelevantToken(t){const e=Utils.getControlledTokens();return e?.some((e=>e.id===t.id))||0===e?.length&&canvas?.tokens?.placeables?.some((t=>t.id===this.hud?.tokenId))}isValidActorOrItemUpdate(t,e){return e?.flags?(Logger.debug("Flags set, do not update hud",{actor:t,data:e}),!1):t?t?this.hud&&t.id===this.hud.actorId?(Logger.debug("Same actor, update hud",{actor:t,data:e}),!0):(Logger.debug("Different actor, do not update hud",{actor:t,data:e}),!1):(Logger.debug("No actor, update hud",{data:e}),!0):void 0}_getHudEnabled(){const t=game.user.role,e=game.user.isGM;return!!Utils.getSetting("enable")&&(!!e||Utils.checkAllow(t))}isLinkedCompendium(t){return Logger.debug("Compendium hook triggered, checking if compendium is linked..."),this.actionHandler.isLinkedCompendium(t)}_getCharacter(t=[]){if(t.length>1)return this.actor=null,this.token=null,this.actionHandler.characterName="Multiple",this.actionHandler.actor=null,this.actionHandler.token=null,this.rollHandler.actor=null,this.rollHandler.token=null,null;const e={token:null,actor:null};if(1===t.length){const o=t[0],i=o.actor;if(!this._isValidCharacter(o))return null;e.token=o,e.actor=i}else 0===t.length&&game.user.character&&this.isAlwaysShow&&(e.actor=game.user.character,e.token=canvas.tokens.placeables.find((t=>t.actor?.id===e.actor.id)));return e.actor?(this.actor=e.actor,this.token=e.token,this.actionHandler.characterName=e.token?.name??e.actor.name,this.actionHandler.actor=e.actor,this.actionHandler.token=e.token,this.rollHandler.actor=e.actor,this.rollHandler.token=e.token,e):null}_isValidCharacter(t={}){const e=t?.actor,o=game.user;return game.user.isGM||e?.testUserPermission(o,"OWNER")}}let d,u,g;Hooks.once("socketlib.ready",(()=>{g=socketlib.registerModule(t.ID),g.register("createDirectories",DataHandler.createDirectories),g.register("saveData",DataHandler.saveData),g.register("getData",DataHandler.getData)})),Hooks.on("ready",(async()=>{u=game.modules.get(t.ID),u.api={ActionListExtender:ActionListExtender,ActionHandler:ActionHandler,Logger:Logger,PreRollHandler:PreRollHandler,RollHandler:RollHandler,SystemManager:SystemManager,Utils:Utils},Hooks.callAll("tokenActionHudCoreApiReady",u)})),Hooks.on("tokenActionHudSystemReady",(async e=>{if(!await Utils.checkModuleCompatibility(e.api.requiredCoreModuleVersion))return;if(!game.modules.get("socketlib")||!game.modules.get("socketlib")?.active)return void Logger.error("This module requires the 'socketlib' module to be installed and enabled.",!0);await g.executeAsGM("createDirectories"),d=new e.api.SystemManager(t.ID),d.registerSettings();const o=new MigrationManager(e.id,g);await o.init(),Utils.switchCSS(Utils.getSetting("style")),Utils.registerHandlebars(),loadTemplates([`modules/${t.ID}/templates/custom-style-form.hbs`,`modules/${t.ID}/templates/group.hbs`,`modules/${t.ID}/templates/list-group.hbs`,`modules/${t.ID}/templates/tab-group.hbs`,`modules/${t.ID}/templates/action.hbs`,`modules/${t.ID}/templates/tagdialog.hbs`]),Hooks.callAll("tokenActionHudCoreReady")})),Hooks.on("canvasReady",(async()=>{Hooks.on("tokenActionHudCoreReady",(async()=>{if(game.user.isGM&&!game.modules.get("color-picker")?.active){!1===Utils.getSetting("startup")&&(Logger.info("To enable color pickers in this module's settings, install the 'Color Picker' module.",!0),Utils.setSetting("startup",!0))}game.tokenActionHud||(game.tokenActionHud=new TokenActionHud(u,d),game.tokenActionHud.socket=g,await game.tokenActionHud.init()),game.tokenActionHud.setTokens(canvas.tokens),Hooks.on("controlToken",(async(t,e)=>{const o={type:"hook",name:"controlToken",data:[t,e]};game.tokenActionHud.update(o)})),Hooks.on("updateToken",((t,e,o)=>{if(!Object.hasOwn(e,"y")&&!Object.hasOwn(e,"x")&&game.tokenActionHud.isValidTokenChange(t,e)){const i={type:"hook",name:"updateToken",data:[t,e,o]};game.tokenActionHud.update(i)}})),Hooks.on("deleteToken",((t,e,o,i)=>{if(game.tokenActionHud.isValidTokenChange(e)){const s={type:"hook",name:"deleteToken",data:[t,e,o,i]};game.tokenActionHud.update(s)}})),Hooks.on("updateActor",((t,e)=>{if(game.tokenActionHud.isValidActorOrItemUpdate(t,e)){const o={type:"hook",name:"updateActor",data:[t,e]};game.tokenActionHud.update(o)}})),Hooks.on("deleteActor",((t,e)=>{if(game.tokenActionHud.isValidActorOrItemUpdate(t,e)){const o={type:"hook",name:"deleteActor",data:[t,e]};game.tokenActionHud.update(o)}})),Hooks.on("deleteItem",(t=>{const e=t.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(e)){const e={type:"hook",name:"deleteItem",data:[t]};game.tokenActionHud.update(e)}})),Hooks.on("createItem",(t=>{const e=t.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(e)){const e={type:"hook",name:"createItem",data:[t]};game.tokenActionHud.update(e)}})),Hooks.on("updateItem",(t=>{const e=t.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(e)){const e={type:"hook",name:"updateItem",data:[t]};game.tokenActionHud.update(e)}})),Hooks.on("renderTokenActionHud",(()=>{game.tokenActionHud.postRender()})),Hooks.on("renderCompendium",((t,e)=>{const o=t?.metadata;if(game.tokenActionHud.isLinkedCompendium(`${o?.package}.${o?.name}`)){const o={type:"hook",name:"renderCompendium",data:[t,e]};game.tokenActionHud.update(o)}})),Hooks.on("deleteCompendium",((t,e)=>{const o=t?.metadata;if(game.tokenActionHud.isLinkedCompendium(`${o?.package}.${o?.name}`)){const o={type:"hook",name:"deleteCompendium",data:[t,e]};game.tokenActionHud.update(o)}})),Hooks.on("createCombat",(t=>{const e={type:"hook",name:"createCombat",data:[t]};game.tokenActionHud.update(e)})),Hooks.on("deleteCombat",(t=>{const e={type:"hook",name:"deleteCombat",data:[t]};game.tokenActionHud.update(e)})),Hooks.on("updateCombat",(t=>{const e={type:"hook",name:"updateCombat",data:[t]};game.tokenActionHud.update(e)})),Hooks.on("updateCombatant",((t,e)=>{const o={type:"hook",name:"updateCombatant",data:[t,e]};game.tokenActionHud.update(o)})),Hooks.on("forceUpdateTokenActionHud",(()=>{game.tokenActionHud.update({type:"hook",name:"forceUpdateTokenActionHud"})})),Hooks.on("createActiveEffect",(()=>{game.tokenActionHud.update({type:"hook",name:"createActiveEffect"})})),Hooks.on("deleteActiveEffect",(()=>{game.tokenActionHud.update({type:"hook",name:"deleteActiveEffect"})}));game.tokenActionHud.update({type:"hook",name:"canvasReady"})}))}));export{o as ACTION_TYPE,ActionHandler,ActionListExtender,i as COMPENDIUM_ACTION_TYPES,s as COMPENDIUM_PACK_TYPES,n as CSS_STYLE,a as CUSTOM_STYLE,CategoryResizer,CompendiumActionHandler,CompendiumMacroPreHandler,CustomStyleForm,e as DELIMITER,DataHandler,r as GROUP_TYPE,GenericActionHandler,l as ITEM_MACRO_ICON,ItemMacroActionListExtender,ItemMacroPreRollHandler,Logger,t as MODULE,MacroActionHandler,MigrationManager,PreRollHandler,RollHandler,c as STYLE_CLASS,SystemManager,TagDialog,TagDialogHelper,Timer,TokenActionHud,Utils,registerSettings};
